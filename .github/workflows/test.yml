name: Run Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m pytest tests/ -v

      - name: Run code quality checks
        run: |
          python -m pylint app/ tests/ --errors-only --score-no

  create-pr:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref != 'refs/heads/main' && !contains(github.ref, 'dependabot')

    steps:
      - uses: actions/checkout@v4

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          base: main
          title: "ğŸš€ ${{
            github.ref_name == 'fix-tests-add-unit-tests' && 'Fix tests and add comprehensive unit tests' ||
            contains(github.ref_name, 'feature/') && format('Feature: {0}', github.ref_name) ||
            contains(github.ref_name, 'bugfix/') && format('Bugfix: {0}', github.ref_name) ||
            format('PR: {0}', github.ref_name)
          }}"
          body: |
            ## ğŸ¤– Automated Pull Request

            This PR was automatically created after successful CI tests.

            ### Branch: `${{ github.ref_name }}`
            ### Commit: ${{ github.sha }}

            ### âœ… CI Status
            - âœ… Tests passed
            - âœ… Code quality checks passed
            - âœ… Ready for review

            ### ğŸ” Code Review Checklist
            - [ ] Code follows project conventions
            - [ ] Tests are comprehensive
            - [ ] Documentation is updated
            - [ ] No breaking changes
            - [ ] Performance impact assessed

            ---
            *Created automatically by GitHub Actions*
          labels: |
            automated-pr
            ready-for-review
          draft: false